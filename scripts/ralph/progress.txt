## Codebase Patterns
- Backend root: `backend/`, FastAPI app at `backend/app/main.py`
- All Pydantic models in `backend/app/models/`, import via `from app.models import ...`
- Run backend commands from `backend/` directory (uvicorn uses `app.main:app`)
- CORS configured for `http://localhost:5173` (Vite dev server)
- Use `pydantic>=2.0` syntax (BaseModel, no `class Config`)
- ActionRegistry in `backend/app/engine/action_registry.py`: use `@register_action` decorator, `ActionContext`/`ActionResult` dataclasses
- Tests go in `backend/tests/`, run with `python -m pytest tests/ -v` from `backend/`
- Action functions in `backend/app/actions/action_functions.py`: all use `(ctx: ActionContext) -> ActionResult` signature, read from `ctx.target_node`/`ctx.params`, return old values in `ActionResult.old_values`
- Use `pytest.approx` for float comparisons in tests

# Ralph Progress Log
Started: 2026年 2月11日 星期三 22时17分10秒 CST
---

## 2026-02-11 22:20 - US-BE-001
- What was implemented: Backend project skeleton with FastAPI app and all Pydantic data models
- Files changed:
  - backend/app/main.py (FastAPI app, CORS, health check)
  - backend/app/models/ontology.py (NodeTypeDef, EdgeTypeDef, OntologyDef)
  - backend/app/models/graph.py (GraphNode, GraphEdge, GraphData)
  - backend/app/models/action.py (DirectEffect, EffectOnTarget, RippleRule, Action, ActionEngine)
  - backend/app/models/workspace.py (Metadata, WorkspaceConfig)
  - backend/app/models/api.py (SimulateRequest, InsightItem, DeltaGraph, SimulateResponse)
  - backend/requirements.txt
  - .gitignore
- **Learnings for future iterations:**
  - All dependencies already installed in conda env, no virtualenv needed
  - RippleRule has `insight_type` and `insight_severity` as direct fields (not nested)
  - Models __init__.py re-exports all models for convenient import
---

## 2026-02-11 - US-BE-002
- What was implemented: ActionRegistry function registry with @register_action decorator, ActionContext/ActionResult dataclasses
- Files changed:
  - backend/app/engine/action_registry.py (ActionContext, ActionResult, @register_action, ActionRegistry class)
  - backend/tests/test_action_registry.py (12 tests covering all acceptance criteria)
- **Learnings for future iterations:**
  - ActionContext and ActionResult are plain dataclasses (not Pydantic), keeping engine layer lightweight
  - `register_from_module` uses `inspect.getmembers(module, callable)` to scan for decorated functions
  - `@register_action` sets `_is_action = True` and `_action_name = func.__name__` on the function object
  - `list_actions()` returns sorted names for deterministic ordering
  - Sandbox mode blocks heredoc-style git commits; use inline `-m` flag instead
---

## 2026-02-11 - US-BE-003
- What was implemented: L1/L2/L3 action functions in actions/action_functions.py
  - L1 Data: `set_property`, `adjust_numeric`, `update_risk_status`
  - L2 Information: `recalculate_valuation`, `compute_margin_gap`
  - L3 Intelligence: `graph_weighted_exposure` (sum/max/count aggregation, direction/edge_type filtering)
- Files changed:
  - backend/app/actions/action_functions.py (6 action functions, all @register_action decorated)
  - backend/tests/test_action_functions.py (20 tests covering all functions + registration)
- **Learnings for future iterations:**
  - All action functions follow uniform `(ctx: ActionContext) -> ActionResult` signature
  - `graph_weighted_exposure` uses `graph.in_edges`/`out_edges` with `data=True` to get edge attributes
  - Floating point precision: use `pytest.approx` for float comparisons in tests
  - Functions read from `ctx.target_node` (dict of node properties) and `ctx.params` (action parameters)
  - Functions return old values in `ActionResult.old_values` for undo/reset capability
---
